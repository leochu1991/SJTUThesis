%# -*- coding: utf-8-unix -*-
%%==================================================
%% chapter_1.tex for SJTU Master Thesis
%%==================================================

\chapter{概述}
\label{chap:intro}
随着当前网络通信与计算机技术的不断发展，在工业领域中越来越多的基于网络的分布式系统得到了应用。为保证分布式网络系统能够实现精确的数据采集、运行控制等实时性任务，工业中对于各个分布式节点的时间同步精度提出了极为严格的要求，尤其是在大多数以工业以太网为基础的控制系统中，已经逐渐对同步精度提出了微秒级甚至纳秒级别的要求。但是，由于实际测控设备之间固有的时钟差异和时钟数据在网络传输中的随机延时，而且现场设备会由于温度变化、电磁干扰、振荡器老化等多种原因而使得自身时钟并不稳定，使得时间误差随时间不断累积，严重破坏了如变电站、电力监控系统等对时钟同步严格的工业应用。因此，一种更加有效且高精度的时钟同步技术成为测控系统中的关键技术之一。

\section{工业领域中时钟同步的技术现状}
时钟同步即保证工业系统内各个节点的时钟能够保持一致，即维护一个全局一致的物理或逻辑时钟，使得系统各节点中与时间有关的信息、时间及行为有一个全局一致的解释\supercite{1}。
常说的时钟同步，主要包含了时刻同步和时间间隔一致。时刻即表示连续流逝时间的某一个瞬间，而时间间隔是指两个时刻之间的间隔长度。所以，时钟同步主要包括频率同步和相位同步两个方面：
\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
	\item 频率同步：指各从时钟自身运行的计数器频率保持相同平均速率。通过频率同步可以保持所有节点以相同的计数频率运行，从而极大减小时钟误差根源，降低了累积时钟误差。频率同步必须依靠接受连续的时钟信息才能计算出真实的频率并对自身作出调整。
	\item 相位同步：指对频率的积分。通过将时钟的相位量化，赋予数值表示，就是时刻。相位同步可以接受离散的时间信息来调整本地时钟。
\end{itemize}
所以说，时钟同步主要是完成对时和守时这两个功能，所谓“对时”，就是通过不定期的对表操作，来将本地时钟的相位与远程节点相位进行同步；守时就是保持频率一致，尽可能的让本地节点和远程节点的时间间隔偏差在一个允许的范围内。

在工业领域时钟同步技术不断发展，主要使用GPS、包时钟同步以及精确时钟同步等时钟同步技术。

\subsection{GPS同步技术}
如超高压变电站等工业系统对于时间同步精度的要求非常高，例如变电站运行人员实时监控电网运行，一旦发生事故后的故障分析，这些都需要统一的时间基准。而以全球定位系统GPS作为时间基准，可以提供非常高的同步精度（达到50ns），而且这种方式不依赖通络的数据负载，直接传递频率和相位信息，让整个系统保持极高的同步性能。然而，这种方式也存在自身弊端。
\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
	\item GPS不适用于室内节点，存在难以选址和安装的问题，这使得GPS同步技术的人力成本增大。
	\item GPS设备本身价格昂贵，而且人们一般会选取高昂的晶振用作备用时钟，以保持系统的安全性。而且若GPS设备大量使用，可想而知后期的更换升级的费用也会十分高昂。
	\item 由于美国政府从未对GPS信号的质量及使用期限给予任何承若何保证，而且美国政府还具有对特定地区GPS信号严重降质处理的能力，所以大量使用GPS会存在严峻的国防安全隐患。
\end{itemize}

\subsection{包时钟同步技术}
所谓包时钟同步技术ToP(Timing over Packet)，就是利用分组网络来传递时间信息，而所传递的时间报文也有多种。
\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
	\item  NTP(Network Time Protocol)协议全称是网络时间协议，主要用来使互联网上计算机保持时间同步，一般而言，NTP可以提供1-50ms的可靠时间源。另外，SNTP(Simple Network Time Protocol)简单网络时钟同步协议也是较为主流的时间同步协议，它能提供接近1ms的同步精度。然后这两种协议比较容易受到网络突发报文的影响而使得同步精度降低。
	\item PTP(Precise Time Protocol)精确时间同步协议，来自于IEEE1588协议标准\supercite{2}。该协议第一版于2002年推出，具备亚微秒级的同步精度，允许同时传递频率和相位信息。第二版于2008年公布，缩短并统一了报文长度，并且引入了透明时钟机制。具备更高的时间同步精度。
\end{itemize}

结合对当前所有同步技术的综合分析可以看出，由于GPS存在国防安全隐患和使用成本高昂等因素，难以大规模应用这种同步技术，而NTP协议主要应用于互联网中保持计算机时间同步，其精度只能达到毫秒级别，同样不适用于对同步精度要求非常高的工业系统中。而PTP同步技术从实现的简单性、精度要求和稳定性方面都能够很好的满足现如今分布式系统对时间同步精度的要求，因此，本文也选取PTP为主要研究对象。

\subsection{精确时钟同步技术}
应用于网络测量和控制系统的精确时钟同步技术是基于IEEE1588标准，也称作PTP协议（Precision Clock Synchronization Protocol）。

自1995年以太网中数据传输速度从10Mb/s提高到100Mb/s后，计算机网络领域一致在尝试解决网络设备时钟同步问题，随后开发出了一套同步协议－－网络时间协议NTP(Network Time Protocol)－－来提高网络设备的同步性能。虽然在不断发展中，NTP协议同步精确度不断提高达到200$\mu$s，但是，面对同步精度要求越来越高的网络实时通信、测量仪器与工业控制领域，NTP难以达到它们的要求。

随后，网络精密时钟同步委员会于2002年在IEEE标准委员会的支持下，推出了IEEE1588时钟同步标准。该标准推出后迅速在Ethernet/IP等基于以太网的总线中得到采用。该协议采用了主从时钟方案，利用报文传递时间信息，基于网络链路的对称性和延时测量技术，来实现主从时钟的频率、相位精确同步。

在2008年，该委员会继续发布了IEEE1588第二版。在第二版标准中，实现了亚微秒级的时钟同步，可以用于军事和实际的测试测量中。而且提供了更为灵活的同步周期、改进了时间戳的表示方法、解决了主时钟容错性能差的问题、提高了网络拓扑变化的适应性。另外，该版本中还引入了透明时钟，增加了端延时机制，有助于明显提高同步精度。

PTP协议主要针对分布式网络系统中的精确时钟同步问题，它能够将系统内部各个独立时钟同步到一个统一的时钟标准上，而且消耗的网络和本地资源非常有限，并带来较高的时钟同步精度。如果硬件时钟能够提供硬件级别的时间戳标记功能，那么其同步精度能够达到亚微秒级别。而且PTP协议实现起来成本很低，也非常方便后期的维护工作。PTP协议与其他时钟同步协议如NTP/SNTP相比，具备如下几个特点\supercite{4}：
\begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
	\item PTP协议适用于局域网中支持组播报文发送的网络通信技术，也非常适合在以太网中实现。
	\item 可以实现亚微秒级别的同步精度，相比之下，NTP/SNTP最多只能达到毫秒级别。
	\item PTP协议所需要的网络资源和计算资源非常少，所以在实现起来消耗的成本不高。
\end{itemize}

随着IEEE1588协议的不断发展与实践，不仅在测试与测量控制、工业自动化领域广泛应用了该协议，而且随后的军事应用、分组通信和电力系统等多个领域也开始逐步将该同步方法应用进去。在国外，2015年3月在TI推出的高性能多核架构KeyStone中\supercite{5}，提供了两个硬件功能来支持IEEE1588：记录时间戳，发送同步脉冲。其中KeyStone1支持two step的时间戳模式，同时也能支持1588协议中规定的PTP报文解析，在国内，2014年12月，OPWILL发布了基于PTN协议分析仪的IEEE1588v2PTP和SyncE测试选件，为运营商提供关键的网络定时和频率同步测试服务来分析全新的IEEE1588v2 PTP和同步以太网（SyncE）协议，从而为运营商的移动回传和LTE测试提供超高性价比测试解决方案。

\section{精确时钟同步技术应用现状}
根据IEEE1588协议内容，系统时钟同步精度应该能够达到亚微秒级\supercite{2}。然而，在实际的应用中，即使严格按照协议标准的内容来实现，仍然难以达到这样的同步精度。例如Padova大学曾严格按照协议标准，实现了一套完整的IEEE1588同步系统\supercite{3}，但是在运行中发现同步精度最高只有100微秒，和预期的同步精度还有很大的差距，更何况在工业现场中，更加复杂的工业环境使得同步精度更加难以保证。

IEEE1588协议的同步原理是采用了主从时钟通过时间戳报文来传递时间信息，并通过估计链路延时来计算最终的时间误差并予以校正。然后，通过对1588协议的深入分析及对现场应用情况的深入了解，可以发现以下因素可能严重破坏1588实际运行的同步精度。

(1) 时间戳精确度

IEEE1588协议的核心就是通过主从时钟对外发布包含时钟信息的报文来实现所有从时钟向主时钟同步。例如在同步过程中，主时钟会对外发送sync报文，该报文中标记的时间戳在理想情况下应该是报文离开主时钟的一瞬间的时间，但是在实际运行中，由于很多时间戳是在物理层之上标记的，报文被标记时间戳后仍会在协议栈中有短暂滞留，这样导致了发送时间戳的不准确，最终破坏了从时钟的同步计算精度\supercite{25}。

(2) 链路不对称性

通过分析1588协议可以看出，从时钟在计算主从时钟偏差时会假设报文传输的往返路径对称，即Master To Slave Delay 和 Slave To Master Delay相等，并据此来求得最终的offset值。严格来讲，这种假设并不成立。首先由于网络传输过程要经过中间节点如交换机等设备，报文在进入这些设备的协议栈会发生排队和堵塞的情况，而这些情况所导致的链路延时变动是无法预知的；另外，报文传输的拓扑结构也并非一成不变的，一旦拓扑结构发生变化，就意味着往返路径可能有极大的不同。这些都是实际运行中链路固有的不对称性表现\supercite{34}，所以，如果只是简单按照1588协议中假设路径对称，那么势必会带来不可忽视的误差。

(3) 网络延时固有抖动

由于1588协议中的报文需要在网络环境下进行传输，而在复杂的网络环境下，报文传输的时间一定会带有随机的抖动漂移，也就是说，即使网络负载良好，拓扑结构也不发生变动的情况下，网络延时仍然会有自身的随机抖动。如果对于这些抖动不进行处理，那么就会导致从时钟不断处于波动之中，甚至有可能导致从时钟系统不稳定。

(4) 主从时钟源晶振漂移

首先，IEEE1588协议的主从时钟偏差的计算方式是假定主从时间偏差值在短时间内是保持不变的。然而真实的情况是，主时钟在发送Sync报文时的偏差值Offset\_1与从时钟最后接收Delay\_Resp报文时的偏差值Offset\_2是不完全一致的，所以最终计算出来的offset并不完全等于真实的Offset\_2\supercite{4}。所以这会导致同步精度变差。

(5) 从时钟校正策略

常规的对从时钟校正策略有直接校正和PI控制器校正，其中，直接校正能够快速对从时钟校正，在最短时间内实现时钟同步，然后，一旦offset值计算中存在较大偏差，那么从时钟将处于不断的快速波动当中，这会严重破坏从时钟的同步性能，甚至可能导致从时钟无法稳定。PI控制器是一种较为典型而简单的控制方法，能够保证从时钟较为处于较为稳定的状态，但是，简单的PI控制器并不能考虑到延时的波动对从时钟带来的影响，所以也无法达到很好的控制效果。

当前针对上述所问题，工业界对IEEE1588协议\supercite{2}进行了深入研究并取得了一定的研究成果。

(1) 时间戳准确度研究现状

为了提高时间戳准确度，尽量使得报文中的时间戳直接来自物理层以可以减少报文在协议栈的停留，2007年推出了首个可以在以太网收发器上集成IEEE1588协议的芯片－DP83640\supercite{4}，该芯片能够将时间戳标记点从原来的应用层下移到数据链路层和物理层之间，从而降低网络流量及协议栈对报文传输延时的影响。又比如，2015年3月TI推出的Keystone架构也同样能够支持物理时间戳标记\supercite{5}。

(2) 链路不对称性研究现状

针对链路延时中的不对称性问题，当前主要的解决方法有通过类似透明时钟来记录报文在中间节点的传输时间，并在从时钟处减去传输时间来计算主从偏差。但这种方式在2008年才提出，目前并未得到广泛应用，它不仅会受时间戳精度影响，而且现有大多数同步系统仍然采用的是早期的边界时钟。所以当前并不具备很好的应用价值。在C. Lei的文章\parencite{57}中采用了自适应滤波算法，该算法能较好的进行滤波，但由于不能对历史纪录进行实时分析，从而无法检测持久性的时延变化。
% 李学桥层提出对主从路径延时和从主路径延时进行加权求平均的方法，其中权值来自于同步报文与延时请求报文的周期比\supercite{6}。在李帅等学者的文献\parencite{7}中提出了一个扩展时钟同步方法来计算不对称路径下的时间偏差。另外，

(3) 网络延时固有抖动研究现状

Jayesh Chhapekar在2012年发表的一篇文章中对IEEE1588数据包的包延时抖动进行数学分析和建模，并以此来观察数据包延时的概率是如何变化的\supercite{8}。但是在真实的工业环境中，由于网络的复杂性和时变性，很难用某个概率分布来拟合固有抖动，所以也很难取得良好的消除抖动效果。文献\parencite{9}中设计了运用卡尔曼滤波算法来计算主从时钟偏差同样有助于减少固有抖动带来的影响。

(4) 从时钟校正策略研究现状

当前普遍方法是采用PI控制器进行校正，如文献\parencite{10}中对PI控制器参数选择进行了评估，但是没有详细研究具体的应用方法。另外由于网络的时变性，无法用固定的参数来控制从时钟，那样会带来很差的自适应性和鲁棒性。除此之外，文献\parencite{11}对PID控制器在时钟同步中的应用进行深入研究，并且采用了经验法来对PID参数进行整定，但该文缺陷是没有把系统参数发生变化情况下的参数调整考虑进去。文献\parencite{12}利用模糊控制算法来估算时钟偏差，这种方法适合于时钟同步周期较大时，但是如果同步周期太大，网络的不确定性干扰加剧，使得模糊控制的效果变差。

\section{本文研究内容}
在IEEE1588协议的实际应用过程中，通过深入研究分析发现了协议本身存在的多种问题，例如未处理网络延时的不对称性及固有抖动，这使得IEEE1588协议在实际应用中无法达到非常理想的同步精度。

\subsection{网络传输时延的随机性和不确定性}
在硬件提供高精度时间戳的情况下，网络传输延时误差成为了影响同步精度的最主要来源。因此，本文也着重考察对网络延时问题的解决方法。文章中将网络时延拆分成固有抖动漂移、暂时性时延突变和持久性时延变化，分别分析各种变化原因，并且从数学统计方法的角度出发，对固有抖动漂移阐述基于最小二乘的时延估计方法，把历史时延数据作为样本序列，从而减小时延抖动或突变对同步精度带来的不良影响；对暂时性时延阶跃突变，采用动态阈值法通过限制阶跃噪声的大小来防止从时钟系统出现过大的振荡；对持久性时延变化使用基于固定滑动时间窗实时检测的方法来及早发现持久性变化，并立即通过样本失效手段来快速消除持久性变化对样本序列及时延估计所带来的波动。

\subsection{从时钟校正的控制策略}
为了提高从时钟稳定性，一般会采用时钟伺服系统来对从时钟进行控制，一般而言，会使用PID控制器来控制从时钟校正量，不过，通过对链路延时的分析，可以发现其中存在一种阶跃性延时。当一个进入稳态的从时钟遇到了阶跃性延时信号时，就会发生一定的抖动并慢慢收敛，这会导致从时钟的频繁调整，从而影响到整个系统的时钟变化\supercite{10,11}。因此文中将采用了多模型PID控制系统，通过对误差信号进行监控，当信号发生较大跳变时调整控制器以提高从时钟系统稳定性。

\subsection{统计方法在晶振源漂移及透明时钟中的应用}
由于IEEE1588中默认了一个假设：即认为主从时间偏差值在短时间内是保持不变的。而在实际情况下，由于主从时钟晶振不一致，这会导致主从时钟便差在实时变化中。这使得难以得到最真实的主从偏差值而无法精确校正。所以，文中将会从统计方法角度出发，针对主从时钟源漂移问题采用多种优化方法，以对从时钟晶振漂移进行补偿从二减小主从偏差的波动。另外，由于IEEE1588v2中引入了透明时钟的概念，为了能够将本文的统计方法应用到透明时钟中，将做出相关差异分析，并阐述处理方案。

\subsection{算法仿真与验证}
在文章后面，本文在深入研究采用的多种时延统计优化算法的前提下，通过在自己搭建的基于stateflow的matlab仿真平台上，分别测试了上述所提两种算法。根据最终试验结果表现来观察所提算法对时钟同步系统的稳定性、鲁棒性和自适应性等当面的优化。

% \subsection{创新点}
% \begin{itemize}[noitemsep,topsep=0pt,parsep=0pt,partopsep=0pt]
% 	\item 基于统计策略的时延处理：针对时钟同步过程中的时延变化，当前的处理方法主要有对主从路径延时和从主路径延时进行加权求平均的方法，通过类似透明时钟来记录报文在中间节点的传输时间的方法，不过，这些方法并不能系统性的一次解决链路延时中存在的多种因素所带来的问题，且类似于透明时钟的方法也容易受到硬件限制而难以达到很好的效果。而本章节中提出的统计方法，提供了一个全新的能同时应对多种链路延时波动因素的思路，利用这种方法，可以很简便的应对固有抖动、暂时性时延突变和持久性时延变化三种情况。
% 	\item 基于多模型PID控制的时钟伺服系统：常规的时钟伺服系统是直接用普通PID控制器进行校正，不过，这种方法不能很好应对链路时延中存在的阶跃变化，因此，文中又提出了一种“多模型PID控制系统”，即通过对控制误差进行检测，一旦发现控制误差发生阶跃变化，就切换控制器，以防止从时钟发生较大抖动。这可以把持续的波动转变成一个瞬时性的“变化”，从而明显减小从时钟的频繁抖动，使整个系统更加稳定。
% 	\item 统计算法在晶振源频率补偿中的应用：常规的频率补偿是在一个时间段内直接把Sync报文的收发时间用来估算主从时钟的频率及差值以进行补偿。但是，这个时间段内很有可能发生链路延时的暂时性变化，即发生排队堵塞，导致有的Sync报文的传输时间很长，导致计算出来的频率有误差。而本文会通过对Sync样本进行处理，过滤掉发生时延突变的报文，只选取稳定传输的报文来进行处理。这样子可以确保频率计算的准确性。
% \end{itemize}

\section{论文安排}
本文的其它章节安排如下，

第二章介绍1588同步协议的运行原理，同时在最后介绍1588协议在实际运行中遇到的一些不可避免的问题，及对于这些问题的已有研究成果。

第三章从网络传输延时的角度来进行分析，并且利用结合数学统计与实时检测相结合的方法来保证延时数据的稳定性、准确性和可靠性。在该章节会首先对传输延时进行数学模型的建立，通过深入分析其特性可得到数学模型，然后依据模型特性，基于相关的数学统计方法，例如最小二乘处理、固定时间窗等，采用符合模型特性的数学统计优化算法。其中，本文还会应用滑动时间窗延时实时检测方案，用以区分暂时性延时和持久性延时，并在此基础上采用不同的处理方案。从而保证从时钟的稳定性。

第四章从统计角度出发，首先针对时钟伺服系统进行分析，然后为了应对其中的链路延时阶跃突变，文中应用了基于多模型PID控制的控制策略，以提高从时钟的稳定性；另外，针对主从时钟源晶振漂移问题，阐述了相关的解决方案，以对从时钟晶振漂移进行频率补偿来减小主从偏差的波动。同时还将对统计算法在透明时钟的应用作出分析，并采用相关的实际应用方案。另外，该章还会利用自己搭建的时钟同步系统仿真平台，并在该平台上对本文中所提到的统计优化算法进行验证。根据仿真结果得出结论，并总结其中的不足之处。

第五章对全文进行总结和展望。